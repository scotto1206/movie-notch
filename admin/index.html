<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Movie Notch CMS</title>
  </head>
  <body>
    <div id="nc-root"></div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        // Load Netlify Identity
        const identityScript = document.createElement('script');
        identityScript.src =
          'https://identity.netlify.com/v1/netlify-identity-widget.js';
        identityScript.onload = () => {
          if (window.netlifyIdentity) {
            const identity = window.netlifyIdentity;

            // Confirmation flow
            const token = new URLSearchParams(
              window.location.hash.substring(1)
            ).get('confirmation_token');
            if (token) {
              identity
                .confirm(token, true)
                .then(() => {
                  window.location.href = '/admin';
                })
                .catch((err) => {
                  alert('Email confirmation failed: ' + err.message);
                });
            }

            // Ensure identity is initialized before any login
            identity.on('init', (user) => {
              if (!user) {
                identity.on('login', () => {
                  document.location.href = '/admin/';
                });
              }
            });

            identity.init();
          }
        };
        document.body.appendChild(identityScript);

        // Load Decap CMS
        const cmsScript = document.createElement('script');
        cmsScript.src = 'https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js';
        document.body.appendChild(cmsScript);
      });
    </script>
  </body>
</html>
