<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Movie Notch CMS</title>
  </head>
  <body>
    <div id="nc-root"></div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const loadScript = (src) =>
          new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = src;
            script.onload = resolve;
            script.onerror = reject;
            document.body.appendChild(script);
          });

        // Load Netlify Identity first
        loadScript('https://identity.netlify.com/v1/netlify-identity-widget.js')
          .then(() => {
            const identity = window.netlifyIdentity;

            identity.on('init', (user) => {
              if (!user) {
                identity.on('login', () => {
                  document.location.href = '/admin/';
                });
              }
            });

            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const confirmationToken = params.get('confirmation_token');

            if (confirmationToken) {
              console.log('Found confirmation token:', confirmationToken);
              identity
                .confirm(confirmationToken, true)
                .then(() => {
                  console.log('Email confirmed successfully.');
                  window.location.href = '/admin';
                })
                .catch((err) => {
                  console.error('Email confirmation failed:', err);
                  alert('Email confirmation failed: ' + err.message);
                });
            } else {
              identity.init();
            }
          })
          .then(() => {
            // Load Decap CMS after identity init
            return loadScript(
              'https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js'
            );
          })
          .catch((err) => {
            console.error('Error loading scripts:', err);
          });
      });
    </script>
  </body>
</html>
